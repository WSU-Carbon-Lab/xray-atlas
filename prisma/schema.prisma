generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model calibrationmethods {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String        @unique
  description String?
  experiments experiments[]
}

model edges {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  targetatom  String
  corestate   String
  experiments experiments[]

  @@unique([targetatom, corestate])
}

model experimentpublications {
  experimentid  String       @db.Uuid
  publicationid String       @db.Uuid
  role          String       @default("cited")
  experiments   experiments  @relation(fields: [experimentid], references: [id], onDelete: Cascade, onUpdate: NoAction)
  publications  publications @relation(fields: [publicationid], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([experimentid, publicationid])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model experimentquality {
  experimentid  String      @id @db.Uuid
  signaltonoise Decimal?    @db.Decimal
  userrating    Int?
  upvotes       Int         @default(0)
  downvotes     Int         @default(0)
  comments      Json?
  lastchecked   DateTime?   @db.Timestamptz(6)
  experiments   experiments @relation(fields: [experimentid], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model experiments {
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sampleid               String                   @db.Uuid
  instrumentid           String
  edgeid                 String                   @db.Uuid
  polarizationid         String                   @db.Uuid
  calibrationid          String?                  @db.Uuid
  experimenttype         ExperimentType?
  isstandard             Boolean                  @default(false)
  referencestandard      String?
  measurementdate        DateTime                 @db.Date
  createdby              String?
  createdat              DateTime                 @default(now()) @db.Timestamptz(6)
  updatedat              DateTime                 @default(now()) @db.Timestamptz(6)
  experimentpublications experimentpublications[]
  experimentquality      experimentquality?
  calibrationmethods     calibrationmethods?      @relation(fields: [calibrationid], references: [id], onUpdate: NoAction)
  users                  users?                   @relation(fields: [createdby], references: [id], onUpdate: NoAction)
  edges                  edges                    @relation(fields: [edgeid], references: [id], onUpdate: NoAction)
  instruments            instruments              @relation(fields: [instrumentid], references: [id], onUpdate: NoAction)
  polarizations          polarizations            @relation(fields: [polarizationid], references: [id], onUpdate: NoAction)
  samples                samples                  @relation(fields: [sampleid], references: [id], onUpdate: NoAction)
  spectrumpoints         spectrumpoints[]
  peaksets               peaksets[]
  // differencespectra    differencespectra[]      // Planned: Difference spectra for experiments with multiple geometries

  @@unique([sampleid, edgeid, instrumentid, measurementdate])
  @@index([sampleid, edgeid, instrumentid, measurementdate], map: "idx_experiment_lookup")
}

// PLANNED: Difference Spectra Model
// This model will store calculated difference spectra for experiments with multiple incident angles/geometries.
// Difference spectra are calculated by subtracting lower incident angle spectra from higher incident angle spectra.
// Only applicable to experiments with more than one incident angle/geometry.
//
// model differencespectra {
//   id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
//   experimentid String      @db.Uuid
//   mode         String      // 'theta' for polar difference spectra, 'phi' for azimuthal
//   lowerangle   Decimal     @db.Decimal
//   higherangle  Decimal     @db.Decimal
//   ispreferred  Boolean     @default(false)
//   points       Json        // Array of {energy: number, absorption: number}
//   createdat    DateTime    @default(now()) @db.Timestamptz(6)
//   experiments  experiments @relation(fields: [experimentid], references: [id], onDelete: Cascade)
//
//   @@unique([experimentid, mode, lowerangle, higherangle])
//   @@index([experimentid, ispreferred])
// }

model facilities {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String        @unique
  city         String?
  country      String?
  facilitytype FacilityType
  instruments  instruments[]
}

model instruments {
  id          String        @id
  name        String
  facilityid  String        @db.Uuid
  link        String?
  status      String        @default("active")
  experiments experiments[]
  facilities  facilities    @relation(fields: [facilityid], references: [id], onUpdate: NoAction)
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model molecules {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  iupacname        String
  inchi            String
  smiles           String
  chemicalformula  String
  casnumber        String?            @unique
  pubchemcid       String?            @unique
  createdat        DateTime           @default(now()) @db.Timestamptz(6)
  updatedat        DateTime           @default(now()) @db.Timestamptz(6)
  imageurl         String?
  createdby        String?
  upvotes          Int                @default(0)
  moleculesynonyms moleculesynonyms[]
  samples          samples[]
  moleculeupvotes  moleculeupvotes[]
  users            users?             @relation(fields: [createdby], references: [clerkid], onUpdate: NoAction)
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model moleculesynonyms {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  moleculeid String    @db.Uuid
  synonym    String
  order      Int       @default(0)
  molecules  molecules @relation(fields: [moleculeid], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([moleculeid, synonym])
  @@index([moleculeid, order])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model polarizations {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  azimuthdeg  Decimal       @db.Decimal
  polardeg    Decimal       @db.Decimal
  experiments experiments[]

  @@index([azimuthdeg, polardeg], map: "idx_polarization_geom")
}

model publications {
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  doi                    String                   @unique
  title                  String
  journal                String?
  year                   Int?
  authors                Json?
  metadata               Json?
  experimentpublications experimentpublications[]
}

model samples {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  moleculeid      String         @db.Uuid
  identifier      String         @unique
  processmethod   ProcessMethod?
  substrate       String?
  solvent         String?
  thickness       Float?
  molecularweight Float?
  preparationdate DateTime?      @db.Date
  vendorid        String?        @db.Uuid
  createdat       DateTime       @default(now()) @db.Timestamptz(6)
  updatedat       DateTime       @default(now()) @db.Timestamptz(6)
  experiments     experiments[]
  molecules       molecules      @relation(fields: [moleculeid], references: [id], onUpdate: NoAction)
  vendors         vendors?       @relation(fields: [vendorid], references: [id], onUpdate: NoAction)
}

model spectrumpoints {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  experimentid String      @db.Uuid
  energyev     Float
  rawabs       Float
  processedabs Float?
  i0           Float?
  experiments  experiments @relation(fields: [experimentid], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([experimentid, energyev])
  @@index([experimentid, energyev], map: "idx_spectrum_energy")
}

model users {
  id                            String            @id
  name                          String
  email                         String            @unique
  imageurl                      String?
  orcid                         String?           @unique(map: "idx_user_orcid")
  role                          String            @default("contributor")
  clerkid                       String            @unique
  contributionAgreementAccepted Boolean           @default(false)
  contributionAgreementDate     DateTime?         @db.Timestamptz(6)
  experiments                   experiments[]
  molecules                     molecules[]
  moleculeupvotes               moleculeupvotes[]
}

model moleculeupvotes {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  moleculeid String    @db.Uuid
  userid     String
  createdat  DateTime  @default(now()) @db.Timestamptz(6)
  molecules  molecules @relation(fields: [moleculeid], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users     @relation(fields: [userid], references: [clerkid], onDelete: Cascade, onUpdate: NoAction)

  @@unique([moleculeid, userid])
  @@index([moleculeid])
  @@index([userid])
}

model vendors {
  id      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name    String    @unique
  url     String?
  samples samples[]
}

model peaksets {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  experimentid String      @db.Uuid
  energyev     Float
  intensity    Float?
  bond         String?
  transition   String?
  createdat    DateTime    @default(now()) @db.Timestamptz(6)
  experiments  experiments @relation(fields: [experimentid], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([experimentid])
}

/// This enum is commented in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
enum CoreLevel {
  K
  L1
  L2
  L3
  M1
  M2
  M3
}

enum FacilityType {
  SYNCHROTRON
  FREE_ELECTRON_LASER
  LAB_SOURCE
}

enum ExperimentType {
  TOTAL_ELECTRON_YIELD
  PARTIAL_ELECTRON_YIELD
  FLUORESCENT_YIELD
  TRANSMISSION
}

enum ProcessMethod {
  DRY
  SOLVENT
}
